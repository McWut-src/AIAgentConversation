# Complete Tutorial: Building AI Agent Conversation Platform with GitHub Copilot

## ðŸ“š Tutorial Overview

This tutorial will guide you through building a complete .NET 8 web application where two AI agents have conversations. You'll learn to:

- Set up a .NET 8 project with Entity Framework Core
- Integrate OpenAI GPT-3.5-turbo API
- Build a single-page Razor application
- Use GitHub Copilot effectively
- Follow strict workflow requirements

**Estimated Time:** 8-10 hours  
**Difficulty:** Intermediate  
**Prerequisites:** Basic C#, HTML, JavaScript knowledge

## ðŸ“‹ Table of Contents

1. [Prerequisites and Setup](#1-prerequisites-and-setup)
2. [Project Initialization](#2-project-initialization)
3. [Setting Up GitHub Copilot](#3-setting-up-github-copilot)
4. [Database Design](#4-database-design)
5. [OpenAI Service Implementation](#5-openai-service-implementation)
6. [API Endpoints](#6-api-endpoints)
7. [User Interface](#7-user-interface)
8. [Testing](#8-testing)
9. [Troubleshooting](#9-troubleshooting)
10. [Next Steps](#10-next-steps)

---

## 1. Prerequisites and Setup

### 1.1 Install Required Software

**Install in this order:**

1. **Visual Studio 2022** (Community, Professional, or Enterprise)
   - Download: https://visualstudio.microsoft.com/
   - During installation, select:
     - âœ… ASP.NET and web development
     - âœ… Data storage and processing
   - Click Install and wait (30-45 minutes)

2. **.NET 8 SDK**
   - Download: https://dotnet.microsoft.com/download/dotnet/8.0
   - Run installer
   - Verify installation:
     ```bash
     dotnet --version
     # Should show 8.0.x
     ```

3. **SQL Server LocalDB** (included with Visual Studio)
   - Verify it's running:
     ```bash
     sqllocaldb info mssqllocaldb
     # Should show instance info
     ```

4. **Git**
   - Download: https://git-scm.com/
   - Use default settings during installation

5. **GitHub Copilot**
   - Sign up: https://github.com/features/copilot
   - In Visual Studio: Extensions â†’ Manage Extensions
   - Search "GitHub Copilot"
   - Install and restart Visual Studio

### 1.2 Get OpenAI API Key

1. Go to https://platform.openai.com/
2. Sign up or log in
3. Navigate to API Keys section
4. Click "Create new secret key"
5. Copy and save the key (you won't see it again!)
6. **Cost:** ~$0.002 per conversation (very cheap)

### 1.3 Verify Everything Works

```bash
# Check .NET
dotnet --version

# Check Git
git --version

# Check LocalDB
sqllocaldb info mssqllocaldb

# Start LocalDB if needed
sqllocaldb start mssqllocaldb
```

---

## 2. Project Initialization

### 2.1 Create Project Directory

```bash
# Create and navigate to project folder
mkdir AIAgentConversation
cd AIAgentConversation

# Initialize Git repository
git init
```

### 2.2 Create .NET Solution and Project

**Open Visual Studio 2022:**

1. Click **"Create a new project"**
2. Search for **"ASP.NET Core Web App"**
3. Click **Next**

**Configure your project:**
- **Project name:** `AIAgentConversation`
- **Location:** Choose your folder
- **Solution name:** `AIAgentConversation`
- Click **Next**

**Additional information:**
- **Framework:** `.NET 8.0 (Long Term Support)`
- **Authentication type:** None
- âœ… Configure for HTTPS
- âœ… Do not use top-level statements (uncheck)
- Click **Create**

### 2.3 Create Folder Structure

In **Solution Explorer**, right-click the project and add these folders:

```
AIAgentConversation/
â”œâ”€â”€ Controllers/     (Add New Folder)
â”œâ”€â”€ Data/           (Add New Folder)
â”œâ”€â”€ Models/         (Add New Folder)
â”œâ”€â”€ Services/       (Add New Folder)
â””â”€â”€ wwwroot/
    â”œâ”€â”€ css/        (Already exists)
    â””â”€â”€ js/         (Add New Folder)
```

### 2.4 Install NuGet Packages

**Right-click project â†’ Manage NuGet Packages**

Install these packages (click Install for each):

1. `Microsoft.EntityFrameworkCore.SqlServer` (version 8.0.x)
2. `Microsoft.EntityFrameworkCore.Tools` (version 8.0.x)
3. `Betalgo.OpenAI` or `OpenAI` (latest version)
4. `Serilog.AspNetCore` (latest 8.0.x)
5. `Serilog.Sinks.Console` (latest)

**Or use Package Manager Console:**

```powershell
Install-Package Microsoft.EntityFrameworkCore.SqlServer -Version 8.0.0
Install-Package Microsoft.EntityFrameworkCore.Tools -Version 8.0.0
Install-Package Betalgo.OpenAI
Install-Package Serilog.AspNetCore
Install-Package Serilog.Sinks.Console
```

### 2.5 Add Project Files

**Create `.gitignore`** in solution root:

Right-click Solution â†’ Add â†’ New Item â†’ Text File â†’ name it `.gitignore`

```gitignore
## Ignore Visual Studio temporary files, build results, and files generated by popular Visual Studio add-ons.

# User-specific files
*.suo
*.user
*.userosscache
*.sln.docstates

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Bb]in/
[Oo]bj/

# Visual Studio cache/options directory
.vs/

# NuGet Packages
*.nupkg
**/packages/*

# User secrets
secrets.json

# Database files
*.mdf
*.ldf
```

**First Git Commit:**

```bash
git add .
git commit -m "Initial project setup with .NET 8 and required packages"
```

---

## 3. Setting Up GitHub Copilot

### 3.1 Create Copilot Instructions File

**In Solution Explorer:**

1. Right-click Solution
2. Add â†’ New Folder â†’ name it `.github`
3. Right-click `.github` folder
4. Add â†’ New Item â†’ Text File
5. Name it `copilot-instructions.md`

**Copy the entire content from the artifact I created earlier** into this file.

### 3.2 Test GitHub Copilot

**Open GitHub Copilot Chat:**
- View â†’ GitHub Copilot Chat
- Or press `Ctrl + /`

**Test commands:**

```
@workspace What are the critical requirements for the database schema?
```

Copilot should respond with information from your `copilot-instructions.md` file, mentioning string-based fields, no separate tables, etc.

```
@workspace What is the exact OpenAI prompt format I should use?
```

Copilot should tell you: `"You are {personality}. Respond to the conversation on {topic}: {history}"`

âœ… If Copilot references your files, you're ready to proceed!

---

## 4. Database Design

### 4.1 Create Entity Models

**Create `Models/Conversation.cs`:**

Right-click Models folder â†’ Add â†’ Class â†’ `Conversation.cs`

**In GitHub Copilot Chat:**

```
@workspace Create the Conversation entity model with Agent1Personality, 
Agent2Personality, Topic, Status, and Messages properties
```

Copilot will generate something like:

```csharp
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace AIAgentConversation.Models
{
    public class Conversation
    {
        [Key]
        public Guid Id { get; set; }

        [Required]
        [MaxLength(500)]
        public string Agent1Personality { get; set; }

        [Required]
        [MaxLength(500)]
        public string Agent2Personality { get; set; }

        [Required]
        [MaxLength(1000)]
        public string Topic { get; set; }

        public int IterationCount { get; set; } = 3;

        [Required]
        [MaxLength(50)]
        public string Status { get; set; } = "InProgress";

        public DateTime StartTime { get; set; } = DateTime.UtcNow;

        public DateTime? EndTime { get; set; }

        // Navigation property
        public ICollection<Message> Messages { get; set; }
    }
}
```

âœ… **Verify:** No foreign keys to Personality or Topic tables!

**Create `Models/Message.cs`:**

```
@workspace Create the Message entity model with ConversationId, 
AgentType, IterationNumber, Content, and Timestamp properties
```

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace AIAgentConversation.Models
{
    public class Message
    {
        [Key]
        public Guid Id { get; set; }

        [Required]
        public Guid ConversationId { get; set; }

        [Required]
        [MaxLength(10)]
        public string AgentType { get; set; } // "A1" or "A2"

        public int IterationNumber { get; set; }

        [Required]
        public string Content { get; set; }

        public DateTime Timestamp { get; set; } = DateTime.UtcNow;

        // Navigation property
        public Conversation Conversation { get; set; }
    }
}
```

### 4.2 Create DbContext

**Create `Data/ApplicationDbContext.cs`:**

```
@workspace Create ApplicationDbContext class with DbSets for 
Conversations and Messages
```

```csharp
using AIAgentConversation.Models;
using Microsoft.EntityFrameworkCore;

namespace AIAgentConversation.Data
{
    public class ApplicationDbContext : DbContext
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        public DbSet<Conversation> Conversations { get; set; }
        public DbSet<Message> Messages { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            // Configure Conversation
            modelBuilder.Entity<Conversation>(entity =>
            {
                entity.HasKey(e => e.Id);
                entity.Property(e => e.Agent1Personality).IsRequired().HasMaxLength(500);
                entity.Property(e => e.Agent2Personality).IsRequired().HasMaxLength(500);
                entity.Property(e => e.Topic).IsRequired().HasMaxLength(1000);
                entity.Property(e => e.Status).IsRequired().HasMaxLength(50);
                entity.Property(e => e.IterationCount).HasDefaultValue(3);
            });

            // Configure Message
            modelBuilder.Entity<Message>(entity =>
            {
                entity.HasKey(e => e.Id);
                entity.Property(e => e.AgentType).IsRequired().HasMaxLength(10);
                entity.Property(e => e.Content).IsRequired();
                
                // Configure relationship
                entity.HasOne(e => e.Conversation)
                    .WithMany(e => e.Messages)
                    .HasForeignKey(e => e.ConversationId)
                    .OnDelete(DeleteBehavior.Cascade);
            });
        }
    }
}
```

### 4.3 Configure Connection String

**Edit `appsettings.json`:**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=AIConversations;Trusted_Connection=True;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

### 4.4 Register DbContext in Program.cs

**Edit `Program.cs`:**

Add after `var builder = WebApplication.CreateBuilder(args);`

```csharp
// Add DbContext
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
```

**Add using statements at the top:**

```csharp
using AIAgentConversation.Data;
using Microsoft.EntityFrameworkCore;
```

### 4.5 Create and Apply Migration

**Open Package Manager Console:**
- Tools â†’ NuGet Package Manager â†’ Package Manager Console

**Run commands:**

```powershell
# Create migration
Add-Migration InitialCreate

# Apply to database
Update-Database
```

âœ… **Success looks like:**
```
Build started...
Build succeeded.
Done.
```

**Verify in SQL Server Object Explorer:**
- View â†’ SQL Server Object Explorer
- Expand (localdb)\mssqllocaldb â†’ Databases â†’ AIConversations â†’ Tables
- You should see: `Conversations` and `Messages`

**Commit your work:**

```bash
git add .
git commit -m "Add database entities and initial migration"
```

---

## 5. OpenAI Service Implementation

### 5.1 Configure User Secrets

**Right-click project â†’ Manage User Secrets**

This opens `secrets.json`. Add:

```json
{
  "OpenAI": {
    "ApiKey": "your-openai-api-key-here"
  }
}
```

Replace `your-openai-api-key-here` with your actual OpenAI API key.

### 5.2 Add OpenAI Configuration to appsettings.json

**Edit `appsettings.json`:**

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=AIConversations;Trusted_Connection=True;MultipleActiveResultSets=true"
  },
  "OpenAI": {
    "ApiKey": "",
    "Model": "gpt-3.5-turbo",
    "MaxTokens": 500,
    "Temperature": 0.7
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

### 5.3 Create OpenAI Service Interface

**Create `Services/IOpenAIService.cs`:**

```
@workspace Create IOpenAIService interface with GenerateResponseAsync method
```

```csharp
using System.Threading.Tasks;

namespace AIAgentConversation.Services
{
    public interface IOpenAIService
    {
        Task<string> GenerateResponseAsync(string personality, string topic, string history);
    }
}
```

### 5.4 Implement OpenAI Service

**Create `Services/OpenAIService.cs`:**

```
@workspace Implement OpenAIService that calls GPT-3.5-turbo with 
personality, topic, and conversation history
```

```csharp
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using OpenAI;
using OpenAI.Chat;
using System;
using System.Threading.Tasks;

namespace AIAgentConversation.Services
{
    public class OpenAIService : IOpenAIService
    {
        private readonly IConfiguration _configuration;
        private readonly ILogger<OpenAIService> _logger;
        private readonly OpenAIClient _client;

        public OpenAIService(IConfiguration configuration, ILogger<OpenAIService> logger)
        {
            _configuration = configuration;
            _logger = logger;
            
            var apiKey = _configuration["OpenAI:ApiKey"];
            _client = new OpenAIClient(apiKey);
        }

        public async Task<string> GenerateResponseAsync(string personality, string topic, string history)
        {
            try
            {
                // CRITICAL: Exact prompt format
                var prompt = $"You are {personality}. Respond to the conversation on {topic}: {history}";

                var chatRequest = new ChatRequest
                {
                    Model = _configuration["OpenAI:Model"] ?? "gpt-3.5-turbo",
                    Messages = new[]
                    {
                        new ChatMessage
                        {
                            Role = "user",
                            Content = prompt
                        }
                    },
                    MaxTokens = int.Parse(_configuration["OpenAI:MaxTokens"] ?? "500"),
                    Temperature = double.Parse(_configuration["OpenAI:Temperature"] ?? "0.7")
                };

                var response = await _client.ChatEndpoint.GetCompletionAsync(chatRequest);
                return response.FirstChoice.Message.Content.Trim();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error calling OpenAI API");
                throw;
            }
        }
    }
}
```

**Note:** Depending on the OpenAI package you installed, the API might be slightly different. Use Copilot to adapt to the exact package API.

### 5.5 Register Service in Program.cs

**Edit `Program.cs`:**

Add after DbContext registration:

```csharp
// Add OpenAI Service
builder.Services.AddScoped<IOpenAIService, OpenAIService>();
```

**Add using statement:**

```csharp
using AIAgentConversation.Services;
```

### 5.6 Configure Serilog

**Edit `Program.cs`** - Add at the very top, before builder creation:

```csharp
using Serilog;

// Configure Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", Serilog.Events.LogEventLevel.Warning)
    .MinimumLevel.Override("System", Serilog.Events.LogEventLevel.Warning)
    .WriteTo.Console()
    .CreateLogger();

try
{
    Log.Information("Starting web application");

    var builder = WebApplication.CreateBuilder(args);
    
    // Use Serilog
    builder.Host.UseSerilog();
    
    // ... rest of your code
}
catch (Exception ex)
{
    Log.Fatal(ex, "Application terminated unexpectedly");
}
finally
{
    Log.CloseAndFlush();
}
```

**Commit your work:**

```bash
git add .
git commit -m "Implement OpenAI service with exact prompt format"
```

---

## 6. API Endpoints

### 6.1 Create DTOs

**Create `Models/DTOs/InitConversationRequest.cs`:**

```csharp
using System.ComponentModel.DataAnnotations;

namespace AIAgentConversation.Models.DTOs
{
    public class InitConversationRequest
    {
        [Required]
        [MaxLength(500)]
        public string Agent1Personality { get; set; }

        [Required]
        [MaxLength(500)]
        public string Agent2Personality { get; set; }

        [Required]
        [MaxLength(1000)]
        public string Topic { get; set; }
    }
}
```

**Create `Models/DTOs/FollowConversationRequest.cs`:**

```csharp
using System;
using System.ComponentModel.DataAnnotations;

namespace AIAgentConversation.Models.DTOs
{
    public class FollowConversationRequest
    {
        [Required]
        public Guid ConversationId { get; set; }
    }
}
```

**Create `Models/DTOs/ConversationResponse.cs`:**

```csharp
using System;

namespace AIAgentConversation.Models.DTOs
{
    public class ConversationResponse
    {
        public Guid ConversationId { get; set; }
        public string Message { get; set; }
        public string AgentType { get; set; }
        public int IterationNumber { get; set; }
        public bool IsOngoing { get; set; }
        public int TotalMessages { get; set; }
    }
}
```

### 6.2 Create Conversation Controller

**Create `Controllers/ConversationController.cs`:**

```
@workspace Create ConversationController with dependency injection for 
DbContext, OpenAIService, and Logger
```

```csharp
using AIAgentConversation.Data;
using AIAgentConversation.Models;
using AIAgentConversation.Models.DTOs;
using AIAgentConversation.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using System;
using System.Linq;
using System.Threading.Tasks;

namespace AIAgentConversation.Controllers
{
    [ApiController]
    [Route("api/conversation")]
    public class ConversationController : ControllerBase
    {
        private readonly ApplicationDbContext _context;
        private readonly IOpenAIService _openAIService;
        private readonly ILogger<ConversationController> _logger;

        public ConversationController(
            ApplicationDbContext context,
            IOpenAIService openAIService,
            ILogger<ConversationController> logger)
        {
            _context = context;
            _openAIService = openAIService;
            _logger = logger;
        }

        // Endpoints will go here
    }
}
```

### 6.3 Implement Init Endpoint

```
@workspace Implement the Init endpoint that creates a conversation, 
calls Agent 1, and returns the first message
```

**Add this method to ConversationController:**

```csharp
[HttpPost("init")]
public async Task<IActionResult> Init([FromBody] InitConversationRequest request)
{
    try
    {
        // Validate
        if (!ModelState.IsValid)
            return BadRequest(ModelState);

        // Trim inputs
        request.Agent1Personality = request.Agent1Personality?.Trim();
        request.Agent2Personality = request.Agent2Personality?.Trim();
        request.Topic = request.Topic?.Trim();

        if (string.IsNullOrWhiteSpace(request.Agent1Personality) ||
            string.IsNullOrWhiteSpace(request.Agent2Personality) ||
            string.IsNullOrWhiteSpace(request.Topic))
        {
            return BadRequest(new { error = "All fields are required" });
        }

        // Create conversation
        var conversation = new Conversation
        {
            Id = Guid.NewGuid(),
            Agent1Personality = request.Agent1Personality,
            Agent2Personality = request.Agent2Personality,
            Topic = request.Topic,
            IterationCount = 3, // Fixed
            Status = "InProgress",
            StartTime = DateTime.UtcNow,
            Messages = new List<Message>()
        };

        await _context.Conversations.AddAsync(conversation);

        // Call OpenAI for Agent 1
        var messageContent = await _openAIService.GenerateResponseAsync(
            request.Agent1Personality,
            request.Topic,
            "");

        // Save message
        var message = new Message
        {
            Id = Guid.NewGuid(),
            ConversationId = conversation.Id,
            AgentType = "A1",
            IterationNumber = 1,
            Content = messageContent,
            Timestamp = DateTime.UtcNow
        };

        conversation.Messages.Add(message);
        await _context.SaveChangesAsync();

        _logger.LogInformation("Conversation {ConversationId} initialized", conversation.Id);

        // Return response
        return Ok(new ConversationResponse
        {
            ConversationId = conversation.Id,
            Message = messageContent,
            AgentType = "A1",
            IterationNumber = 1,
            IsOngoing = true,
            TotalMessages = 1
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error initializing conversation");
        return StatusCode(500, new { error = "Internal server error", message = ex.Message });
    }
}
```

### 6.4 Implement Follow Endpoint

```
@workspace Implement the Follow endpoint that continues the conversation 
with proper agent alternation
```

**Add this method to ConversationController:**

```csharp
[HttpPost("follow")]
public async Task<IActionResult> Follow([FromBody] FollowConversationRequest request)
{
    try
    {
        // Retrieve conversation with messages
        var conversation = await _context.Conversations
            .Include(c => c.Messages)
            .FirstOrDefaultAsync(c => c.Id == request.ConversationId);

        if (conversation == null)
            return NotFound(new { error = "Conversation not found" });

        if (conversation.Status == "Completed")
            return BadRequest(new { error = "Conversation already completed" });

        // Calculate next agent (CRITICAL: odd->A2, even->A1)
        var messageCount = conversation.Messages.Count;
        var nextAgent = messageCount % 2 == 1 ? "A2" : "A1";
        var iterationNumber = (messageCount / 2) + 1;

        // Build history (CRITICAL: simple concatenation)
        var history = string.Join("\n",
            conversation.Messages
                .OrderBy(m => m.Timestamp)
                .Select(m => $"{m.AgentType}: {m.Content}"));

        // Get next agent personality
        var personality = nextAgent == "A1"
            ? conversation.Agent1Personality
            : conversation.Agent2Personality;

        // Call OpenAI
        var messageContent = await _openAIService.GenerateResponseAsync(
            personality,
            conversation.Topic,
            history);

        // Save message
        var message = new Message
        {
            Id = Guid.NewGuid(),
            ConversationId = conversation.Id,
            AgentType = nextAgent,
            IterationNumber = iterationNumber,
            Content = messageContent,
            Timestamp = DateTime.UtcNow
        };

        conversation.Messages.Add(message);

        // Check completion (CRITICAL: exactly 6 messages)
        var totalMessages = messageCount + 1;
        var isOngoing = totalMessages < 6;

        if (totalMessages == 6)
        {
            conversation.Status = "Completed";
            conversation.EndTime = DateTime.UtcNow;
            _logger.LogInformation("Conversation {ConversationId} completed", conversation.Id);
        }

        await _context.SaveChangesAsync();

        // Return response
        return Ok(new ConversationResponse
        {
            ConversationId = conversation.Id,
            Message = messageContent,
            AgentType = nextAgent,
            IterationNumber = iterationNumber,
            IsOngoing = isOngoing,
            TotalMessages = totalMessages
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error continuing conversation");
        return StatusCode(500, new { error = "Internal server error", message = ex.Message });
    }
}
```

### 6.5 Implement Get Endpoint

```
@workspace Implement the Get endpoint that returns a completed 
conversation in markdown format
```

**Add this method to ConversationController:**

```csharp
[HttpGet("{id}")]
public async Task<IActionResult> Get(Guid id)
{
    try
    {
        var conversation = await _context.Conversations
            .Include(c => c.Messages)
            .FirstOrDefaultAsync(c => c.Id == id);

        if (conversation == null)
            return NotFound(new { error = "Conversation not found" });

        if (conversation.Status != "Completed")
            return BadRequest(new { error = "Conversation not yet completed" });

        // Format as markdown (CRITICAL: **AgentType:** format)
        var markdown = string.Join("\n",
            conversation.Messages
                .OrderBy(m => m.Timestamp)
                .Select(m => $"**{m.AgentType}:** {m.Content}"));

        return Ok(new
        {
            conversationId = conversation.Id,
            markdown = markdown,
            agent1Personality = conversation.Agent1Personality,
            agent2Personality = conversation.Agent2Personality,
            topic = conversation.Topic,
            status = conversation.Status,
            messageCount = conversation.Messages.Count
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error retrieving conversation");
        return StatusCode(500, new { error = "Internal server error", message = ex.Message });
    }
}
```

**Test your API:**

Press **F5** to run the application.

**Use Postman or curl to test init endpoint:**

```bash
curl -X POST https://localhost:5001/api/conversation/init \
  -H "Content-Type: application/json" \
  -d '{
    "agent1Personality": "Logical analyst",
    "agent2Personality": "Creative poet",
    "topic": "Space exploration"
  }'
```

âœ… You should get back a JSON response with a conversationId and first message!

**Commit your work:**

```bash
git add .
git commit -m "Implement all three API endpoints with strict workflow"
```

---

## 7. User Interface

### 7.1 Create Index Razor Page

**Right-click Pages folder â†’ Add â†’ Razor Page â†’ Name it `Index`**

This creates `Index.cshtml` and `Index.cshtml.cs`

### 7.2 Edit Index.cshtml

```
@workspace Create the Index.cshtml page with text inputs for personalities 
and topic, plus conversation display area
```

**Replace content of `Pages/Index.cshtml`:**

```html
@page
@model IndexModel
@{
    ViewData["Title"] = "AI Agent Conversation";
}

<div class="container">
    <h1>AI Agent Conversation Platform</h1>
    <p>Watch two AI agents converse on any topic!</p>

    <div class="input-section">
        <div class="form-group">
            <label for="agent1-personality">Agent 1 Personality:</label>
            <input type="text" id="agent1-personality" class="form-control" 
                   placeholder="e.g., Logical analyst who values data" />
        </div>

        <div class="form-group">
            <label for="agent2-personality">Agent 2 Personality:</label>
            <input type="text" id="agent2-personality" class="form-control" 
                   placeholder="e.g., Creative thinker who loves metaphors" />
        </div>

        <div class="form-group">
            <label for="topic">Topic:</label>
            <input type="text" id="topic" class="form-control" 
                   placeholder="e.g., The future of space exploration" />
        </div>

        <button id="start-button" class="btn btn-primary">Start Conversation</button>
    </div>

    <div id="conversation-container" class="conversation-display"></div>
    <div id="markdown-container" class="markdown-display" style="display: none;"></div>
    <div id="error-container" class="error-display" style="display: none;"></div>
</div>

@section Scripts {
    <script src="~/js/conversation.js"></script>
}
```

### 7.3 Create CSS Styles

**Edit `wwwroot/css/site.css`** - Add at the bottom:

```css
/* Container */
.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* Input Section */
.input-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

/* Conversation Display */
.conversation-display {
    margin-top: 30px;
    min-height: 200px;
}

/* Message Bubbles - CRITICAL: A1 left, A2 right */
.message-bubble {
    margin: 15px 0;
    padding: 12px 16px;
    border-radius: 18px;
    max-width: 70%;
    word-wrap: break-word;
    clear: both;
}

.message-bubble-a1 {
    background-color: #007bff;
    color: white;
    float: left;
    margin-right: auto;
}

.message-bubble-a2 {
    background-color: #28a745;
    color: white;
    float: right;
    margin-left: auto;
}

.message-agent {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 4px;
}

/* Waiting Indicator - CRITICAL: Static text only */
.waiting-indicator {
    padding: 12px 16px;
    color: #999;
    font-size: 20px;
    margin: 15px 0;
    clear: both;
}

.waiting-left {
    float: left;
}

.waiting-right {
    float: right;
}

/* Markdown Display */
.markdown-display {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 30px;
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    line-height: 1.6;
}

/* Error Display */
.error-display {
    background-color: #f8d7da;
    color: #721c24;
    padding: 15px;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    margin-top: 20px;
}

/* Clear floats */
.conversation-display::after {
    content: "";
    display: table;
    clear: both;
}
```

### 7.4 Create JavaScript Client Logic

**Create `wwwroot/js/conversation.js`:**

```
@workspace Create conversation.js with functions for starting conversations, 
handling API calls, and displaying messages
```

```javascript
// Global variables - CRITICAL: Store in JS variable, not localStorage
let conversationId = null;
let isConversationActive = false;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const startButton = document.getElementById('start-button');
    startButton.addEventListener('click', startConversation);
});

// Start conversation
async function startConversation() {
    try {
        // Get input values
        const agent1 = document.getElementById('agent1-personality').value.trim();
        const agent2 = document.getElementById('agent2-personality').value.trim();
        const topic = document.getElementById('topic').value.trim();

        // Validate inputs
        if (!agent1 || !agent2 || !topic) {
            displayError('Please fill in all fields');
            return;
        }

        // Clear previous conversation
        const conversationContainer = document.getElementById('conversation-container');
        const markdownContainer = document.getElementById('markdown-container');
        const errorContainer = document.getElementById('error-container');
        
        conversationContainer.innerHTML = '';
        markdownContainer.style.display = 'none';
        errorContainer.style.display = 'none';
        
        isConversationActive = true;

        // Show initial waiting indicator (left side for A1)
        const waitingIndicator = createWaitingIndicator('left');
        conversationContainer.appendChild(waitingIndicator);

        // Call init API
        const response = await fetch('/api/conversation/init', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                agent1Personality: agent1,
                agent2Personality: agent2,
                topic: topic
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to initialize conversation');
        }

        const data = await response.json();
        
        // Store conversation ID
        conversationId = data.conversationId;

        // Remove waiting indicator
        waitingIndicator.remove();

        // Display A1 message
        const messageBubble = createMessageBubble(data.message, data.agentType);
        conversationContainer.appendChild(messageBubble);

        // Continue if ongoing
        if (data.isOngoing && isConversationActive) {
            // Show waiting for A2 (right side)
            const nextWaiting = createWaitingIndicator('right');
            conversationContainer.appendChild(nextWaiting);
            
            // Continue conversation
            await continueConversation();
        } else {
            // Fetch and display markdown
            await displayMarkdown();
        }

    } catch (error) {
        console.error('Error starting conversation:', error);
        displayError(error.message);
        isConversationActive = false;
    }
}

// Continue conversation
async function continueConversation() {
    try {
        if (!isConversationActive) return;

        const response = await fetch('/api/conversation/follow', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                conversationId: conversationId
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to continue conversation');
        }

        const data = await response.json();
        
        const conversationContainer = document.getElementById('conversation-container');
        
        // Remove last waiting indicator
        const waitingIndicators = conversationContainer.querySelectorAll('.waiting-indicator');
        if (waitingIndicators.length > 0) {
            waitingIndicators[waitingIndicators.length - 1].remove();
        }

        // Display message
        const messageBubble = createMessageBubble(data.message, data.agentType);
        conversationContainer.appendChild(messageBubble);

        // Check if ongoing
        if (data.isOngoing && isConversationActive) {
            // Show waiting indicator for next agent
            const side = data.agentType === 'A1' ? 'right' : 'left';
            const nextWaiting = createWaitingIndicator(side);
            conversationContainer.appendChild(nextWaiting);
            
            // Recursively continue
            await continueConversation();
        } else {
            // Conversation complete - show markdown
            isConversationActive = false;
            await displayMarkdown();
        }

    } catch (error) {
        console.error('Error continuing conversation:', error);
        displayError(error.message);
        isConversationActive = false;
    }
}

// Display complete conversation in markdown
async function displayMarkdown() {
    try {
        const response = await fetch(`/api/conversation/${conversationId}`);

        if (!response.ok) {
            throw new Error('Failed to retrieve conversation');
        }

        const data = await response.json();
        
        // Hide conversation bubbles
        const conversationContainer = document.getElementById('conversation-container');
        conversationContainer.style.display = 'none';
        
        // Show markdown
        const markdownContainer = document.getElementById('markdown-container');
        markdownContainer.style.display = 'block';
        markdownContainer.textContent = data.markdown;

    } catch (error) {
        console.error('Error displaying markdown:', error);
        displayError(error.message);
    }
}

// Create message bubble
function createMessageBubble(message, agentType) {
    const bubble = document.createElement('div');
    bubble.className = `message-bubble message-bubble-${agentType.toLowerCase()}`;
    
    const agentLabel = document.createElement('div');
    agentLabel.className = 'message-agent';
    agentLabel.textContent = agentType;
    
    const messageText = document.createElement('div');
    messageText.textContent = message;
    
    bubble.appendChild(agentLabel);
    bubble.appendChild(messageText);
    
    return bubble;
}

// Create waiting indicator - CRITICAL: Static text only
function createWaitingIndicator(side) {
    const indicator = document.createElement('div');
    indicator.className = `waiting-indicator waiting-${side}`;
    indicator.textContent = '...';
    return indicator;
}

// Display error
function displayError(message) {
    const errorContainer = document.getElementById('error-container');
    errorContainer.textContent = `Error: ${message}`;
    errorContainer.style.display = 'block';
    
    // Log to console
    console.error('Conversation error:', message);
}
```

### 7.5 Update Program.cs for Razor Pages

**Edit `Program.cs`** - Make sure you have:

```csharp
// Add services
builder.Services.AddRazorPages();

// ... after app is built ...

// Configure middleware
app.UseStaticFiles();
app.UseRouting();
app.UseAuthorization();

app.MapRazorPages();
app.MapControllers();

app.Run();
```

**Commit your work:**

```bash
git add .
git commit -m "Implement complete UI with Razor page, CSS, and JavaScript"
```

---

## 8. Testing

### 8.1 Run the Application

**Press F5 in Visual Studio**

Your browser should open to `https://localhost:5001`

### 8.2 Test Happy Path

**Enter test data:**
- Agent 1 Personality: `Logical analyst who values data and evidence`
- Agent 2 Personality: `Creative poet who thinks in metaphors`
- Topic: `The future of artificial intelligence`

**Click "Start Conversation"**

**Expected behavior:**
1. "..." appears on left (waiting for A1)
2. A1 message appears in blue bubble on left
3. "..." appears on right (waiting for A2)
4. A2 message appears in green bubble on right
5. Pattern repeats: A1 left, A2 right, A1 left, A2 right, A1 left, A2 right
6. After 6 messages, all bubbles replaced with markdown text

âœ… **Success:** You should see 6 messages alternating sides, then markdown format!

### 8.3 Verify Database

**Open SQL Server Object Explorer:**
- View â†’ SQL Server Object Explorer
- Navigate to (localdb)\mssqllocaldb â†’ Databases â†’ AIConversations

**Run query on Conversations:**
```sql
SELECT Id, Agent1Personality, Agent2Personality, Topic, Status, 
       (SELECT COUNT(*) FROM Messages WHERE ConversationId = Conversations.Id) as MessageCount
FROM Conversations
ORDER BY StartTime DESC
```

âœ… **Should show:** 1 row with Status='Completed', MessageCount=6

**Run query on Messages:**
```sql
SELECT ConversationId, AgentType, IterationNumber, 
       LEFT(Content, 50) as ContentPreview, Timestamp
FROM Messages
ORDER BY ConversationId, Timestamp
```

âœ… **Should show:** 6 rows with pattern A1-1, A2-1, A1-2, A2-2, A1-3, A2-3

### 8.4 Test Error Handling

**Test with invalid API key:**

1. Right-click project â†’ Manage User Secrets
2. Change API key to invalid value
3. Try to start conversation
4. âœ… Should see error message in red box
5. âœ… Check console (F12) for error logs

**Restore valid API key and test again**

### 8.5 Test Stateless Behavior

1. Start a conversation
2. Wait for 2-3 messages to appear
3. **Press F5 to refresh the page**
4. âœ… Conversation display should clear
5. Start a new conversation
6. âœ… Should work normally with new conversationId

### 8.6 Verification Checklist

Run through this checklist:

```
â–¡ Conversation entity stores personalities/topic as strings
â–¡ No Personality or Topic tables in database
â–¡ IterationCount is 3 (check database)
â–¡ Exactly 6 messages per conversation
â–¡ Agent alternation: A1, A2, A1, A2, A1, A2
â–¡ A1 messages on left (blue)
â–¡ A2 messages on right (green)
â–¡ Static "..." waiting indicator (no animation)
â–¡ Markdown displays after 6 messages
â–¡ Page refresh clears conversation (stateless)
â–¡ Errors display in UI
â–¡ Serilog logs to console (check Output window)
â–¡ OpenAI uses gpt-3.5-turbo
â–¡ Prompt format correct (check logs)
â–¡ History is concatenated correctly
```

**Commit your final working version:**

```bash
git add .
git commit -m "Complete working application - all tests passing"
```

---

## 9. Troubleshooting

### Problem: "Cannot open database"

**Solution:**
```bash
# Check LocalDB status
sqllocaldb info mssqllocaldb

# Start LocalDB
sqllocaldb start mssqllocaldb

# Recreate database
# In Package Manager Console:
Drop-Database
Update-Database
```

### Problem: "OpenAI API Error 401 Unauthorized"

**Solution:**
1. Verify API key is correct
2. Check user secrets: Right-click project â†’ Manage User Secrets
3. Ensure key has no extra spaces
4. Verify key is active on OpenAI dashboard

### Problem: "Agent alternation is wrong"

**Check the logic in Follow endpoint:**
```csharp
var nextAgent = messageCount % 2 == 1 ? "A2" : "A1";
```

This means:
- Message count 1 (after init) â†’ next is A2 âœ“
- Message count 2 â†’ next is A1 âœ“
- Message count 3 â†’ next is A2 âœ“
- Message count 4 â†’ next is A1 âœ“
- Message count 5 â†’ next is A2 âœ“

### Problem: "Conversation never completes"

**Check completion logic:**
```csharp
var totalMessages = messageCount + 1; // Count AFTER adding new message
var isOngoing = totalMessages < 6;

if (totalMessages == 6)
{
    conversation.Status = "Completed";
    // ...
}
```

### Problem: "JavaScript not loading"

**Verify:**
1. File is in `wwwroot/js/conversation.js`
2. `@section Scripts` is in Index.cshtml
3. Check browser console (F12) for errors

### Problem: "Bubbles not styled correctly"

**Check CSS classes match:**
- JavaScript creates: `message-bubble-a1` and `message-bubble-a2`
- CSS defines: `.message-bubble-a1` and `.message-bubble-a2`

### Problem: "History not concatenating"

**Check Follow endpoint:**
```csharp
var history = string.Join("\n",
    conversation.Messages
        .OrderBy(m => m.Timestamp)
        .Select(m => $"{m.AgentType}: {m.Content}"));
```

Should produce: `"A1: msg1\nA2: msg2\nA1: msg3"`

### Problem: "Markdown not displaying"

**Check:**
1. Conversation Status is "Completed"
2. Get endpoint only returns if Status == "Completed"
3. JavaScript calls displayMarkdown() when isOngoing === false

---

## 10. Next Steps

### 10.1 Verify Your Implementation

**Test your application thoroughly:**
- Start a conversation with different personalities and topics
- Verify all 6 messages appear correctly
- Check the markdown output at the end
- Review console logs for any errors
- Test with various conversation topics

**Code Quality Checklist:**
- All API endpoints return proper status codes
- Error handling is implemented throughout
- Input validation works correctly
- Database operations complete successfully
- UI updates reflect the conversation flow

### 10.2 Enhancements and Next Steps

**Ideas for v2.0:**
- Add conversation history page
- Allow custom iteration count
- Add dropdown for pre-defined personalities
- Implement real-time streaming with SignalR
- Add user authentication
- Export conversations to PDF
- Add conversation analytics

### 10.3 Deployment

**For local network access:**

Edit `Properties/launchSettings.json`:
```json
"applicationUrl": "https://0.0.0.0:5001;http://0.0.0.0:5000"
```

**For production:**
- Use Azure App Service or IIS
- Use production SQL Server (not LocalDB)
- Store API keys in Azure Key Vault
- Add authentication and rate limiting
- Enable file logging with Serilog

### 10.4 Learning Resources

**Continue learning:**
- [ASP.NET Core Documentation](https://docs.microsoft.com/aspnet/core)
- [Entity Framework Core](https://docs.microsoft.com/ef/core)
- [OpenAI API Documentation](https://platform.openai.com/docs)
- [GitHub Copilot Best Practices](https://github.com/features/copilot)

### 10.5 Share Your Project

**Create a README.md** in your repository with:
- Project description
- Setup instructions
- Screenshots
- Known limitations

**Push to GitHub:**
```bash
git remote add origin https://github.com/yourusername/AIAgentConversation.git
git push -u origin main
```

---

## ðŸ“Š Tutorial Summary

**What You Built:**
âœ… Full-stack .NET 8 web application  
âœ… Entity Framework Core with SQL Server  
âœ… OpenAI GPT-3.5-turbo integration  
âœ… RESTful API with 3 endpoints  
âœ… Single-page Razor application  
âœ… Real-time conversation display  
âœ… Strict workflow adherence  
âœ… Proper error handling and logging  

**Skills Practiced:**
- ASP.NET Core MVC and API development
- Entity Framework Core migrations
- OpenAI API integration
- JavaScript async/await and fetch
- CSS styling without frameworks
- GitHub Copilot AI-assisted development
- Following strict technical specifications

**Files Created:**
- 2 Entity models (Conversation, Message)
- 1 DbContext class
- 3 DTO classes
- 1 Service interface + implementation
- 1 API Controller with 3 endpoints
- 1 Razor page with CSS and JavaScript
- Configuration files (appsettings.json, appsettings.Development.json)

**Lines of Code:** ~800-1000 lines

---

## ðŸŽ‰ Congratulations!

You've successfully built a complete AI Agent Conversation Platform using:
- âœ… .NET 8 and ASP.NET Core
- âœ… Entity Framework Core
- âœ… OpenAI GPT-3.5-turbo
- âœ… Razor Pages
- âœ… GitHub Copilot

**Your application:**
- Follows strict workflow specifications
- Uses simplified architecture (string-based fields)
- Implements exact prompt format
- Ensures correct agent alternation
- Displays conversations in real-time
- Is stateless and session-independent
- Logs errors with Serilog

**Keep building and learning!** ðŸš€

---

## ðŸ“ž Support

**If you get stuck:**
1. Review the [API.md](API.md) for API details
2. Check [UI.md](UI.md) for UI implementation guidance
3. Use GitHub Copilot Chat: `@workspace help with [your problem]`
4. Review the Troubleshooting section above
5. Check the [README.md](README.md) for additional documentation
6. Consult [AI_CUSTOMIZATION_GUIDE.md](AI_CUSTOMIZATION_GUIDE.md) for AI behavior

**Happy Coding!** ðŸŽ¯